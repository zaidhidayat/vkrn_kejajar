<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VKRN Sanxing Kejajar</title>

  <link rel="icon" type="image/png" href="https://iili.io/FqYzOKB.png">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --blue: #0ea5e9;
      --green: #16a34a;
      --white: #ffffff;
      --gold: #eab308;
      --orange: #f97316;
    }

    body {
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, #e0f2fe, #ecfdf5);
    }

    .app {
      max-width: 430px;
      margin: 0 auto;
      background: var(--white);
      min-height: 100vh;
      padding-bottom: 80px;
      border-left: 1px solid var(--gold);
      border-right: 1px solid var(--gold);
      position: relative;
    }

    .hidden { display: none !important; }

    /* HEADER */
    .app-header {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      background: linear-gradient(90deg, var(--blue), var(--green));
      border-bottom: 1px solid var(--gold);
      position: sticky;
      top: 0;
      z-index: 5;
      color: #ecfdf5;
    }

    .header-text {
      display: flex;
      flex-direction: column;
    }
    .header-title {
      font-size: 15px;
      font-weight: 600;
    }
    .header-subtitle {
      font-size: 11px;
      color:#dcfce7;
    }

    /* CONTENT */
    .page-container {
      padding: 16px;
    }
    .page { display: none; }
    .page.active-page { display: block; }

    /* SEARCH */
    .search-bar {
      margin-bottom: 50px;
      margin-top: 40px;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 999px;
      border: 5px solid #bfdbfe;
      font-size: 18px;
      outline: none;
      box-shadow: 0 1px 2px rgba(15,23,42,0.06);
    }

    .search-input:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 2px rgba(59,130,246,0.25);
    }

    /* CARD */
    .download-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .download-card {
      display: flex;
      align-items: center;
      background: #f9fafb;
      border: 1px solid var(--gold);
      border-radius: 14px;
      padding: 10px;
      text-decoration: none;
      color: #0f172a;
      box-shadow: 0 1px 3px rgba(15,23,42,0.08);
      min-height: 80px;
      cursor: pointer;
    }

    /* THUMBNAIL PDF-STYLE */
    .download-thumb {
      width: 60px;
      height: 80px;
      border-radius: 6px;
      object-fit: cover;
      border: 1px solid var(--gold);
      margin-right: 12px;
      flex-shrink: 0;
      background:#ffffff;
    }

    /* TEKS 2 KOLOM */
    .info-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      column-gap: 6px;
      row-gap: 2px;
      font-size: 12px;
    }

    .info-label {
      font-weight: 600;
      color:#0369a1;
      white-space: nowrap;
    }

    .info-value {
      color:#0f172a;
      word-break: break-word;
    }

    /* NAV BAWAH */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 430px;
      background: #ffffff;
      border-top: 1px solid var(--gold);
      display: flex;
      justify-content: space-around;
      padding: px 0;
      z-index: 20;
    }
    .nav-item {
      background: transparent;
      border: none;
      font-size: 16px;
      padding: 18px 20px;
      border-radius: 12px;
      cursor: pointer;
    }
    .nav-item.active {
      background:#dcfce7;
      border:1px solid var(--gold);
      font-weight:600;
    }

    /* VIEWER GAMBAR & TOMBOL KEMBALI */
    .viewer {
      padding: 12px 12px 90px;
    }

    .viewer-img-wrapper {
      display: flex;
      justify-content: center;
    }

    .viewer-img {
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid var(--gold);
    }

    /* tombol kembali di BAWAH gambar, besar & oranye */
    .viewer-back {
      margin-top: 12px;
      display: flex;
      justify-content: center;
    }

    .viewer-back-btn {
      padding: 10px 18px;
      border-radius: 12px;
      border: 1px solid #ea580c;
      background: var(--orange);
      font-size: 20px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .viewer-back-btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(0,0,0,0.18);
    }

    /* Hapus teks keterangan di bawah gambar (disembunyikan) */
    .viewer-caption {
      display: none;
    }

    /* FAB WHATSAPP */
    .wa-fab {
      position: absolute;
      right: 16px;
      bottom: 90px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      background: #25D366;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 30;
      padding: 0;               /* padding 0px sesuai permintaan */
    }

    .wa-fab img {
      width: 42px;
      height: 42px;
      display: block;
    }

    /* FORM WHATSAPP ‚Äì lebih besar & di tengah */
    .wa-form {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: calc(100% - 32px);
      max-width: 400px;
      padding: 18px 18px 20px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      z-index: 35;
      font-size: 16px;
    }

    .wa-form-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
      text-align: center;
    }

    /* ROW form: label kiri, isi kanan */
    .wa-form-row {
      margin-bottom: 10px;
      font-size: 16px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .wa-form-label {
      font-weight: 600;
      font-size: 16px;
      min-width: 110px;  /* lebar tetap di kiri */
      margin: 0;
      padding-top: 4px;  /* sejajarkan dengan input */
    }

    .wa-form-static {
      font-size: 16px;
      color:#0f172a;
      flex: 1;
    }

    .wa-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 16px;
      outline: none;
      flex: 1;
    }

    .wa-input:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.25);
    }

    .wa-input[readonly] {
      background:#e5e7eb;
    }

    .wa-form-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 8px;
    }

    .wa-btn-send {
      flex: 1;
      padding: 20px 12px;
      border-radius: 12px;
      border: none;
      background:#22c55e;
      color:white;
      font-size: 16px;
      font-weight:600;
      cursor:pointer;
    }

    .wa-btn-close {
      padding: 20px 30px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      background:yellow;
      font-size: 18px;
      cursor:pointer;
      white-space: nowrap;
    }

    @media (max-width: 360px) {
      .header-title { font-size: 14px; }
      .download-thumb { width: 52px; height: 72px; }
      .wa-form-label {
        min-width: 90px;
      }
    }
  </style>
</head>
<body>

<div class="app">
  <header class="app-header">
    <div class="header-text">
      <div class="header-title">VKRN Sanxing Kejajar</div>
      <div class="header-subtitle" id="header-subtitle">Pemasangan</div>
    </div>
  </header>

  <!-- LIST & PENCARIAN -->
  <main class="page-container" id="main-list-container">
    <!-- Halaman Pemasangan -->
    <section id="pemasangan" class="page active-page">
      <!-- kotak pencarian -->
      <div class="search-bar">
        <input
          type="text"
          id="search-input"
          class="search-input"
          placeholder="Cari IDPEL / Nama / Alamat / Petugas..."
          autocomplete="off"
        >
      </div>

      <div id="download-list" class="download-list"></div>
    </section>

    <!-- Halaman Laporan (kosong) -->
    <section id="laporan" class="page">
      <!-- nanti diisi laporan -->
    </section>
  </main>

  <!-- VIEWER GAMBAR & WHATSAPP -->
  <div id="viewer" class="viewer hidden">
    <div class="viewer-img-wrapper">
      <img id="viewer-img" class="viewer-img" src="" alt="Foto pemasangan">
    </div>

    <!-- tombol kembali SEKARANG di bawah gambar -->
    <div class="viewer-back">
      <button type="button" class="viewer-back-btn" id="viewer-back-btn">‚¨Ö Kembali ke daftar</button>
    </div>

    <!-- caption disembunyikan via CSS -->
    <div class="viewer-caption" id="viewer-caption"></div>

    <!-- FAB WA -->
    <button type="button" id="wa-fab" class="wa-fab">
      <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
    </button>

    <!-- FORM WA -->
    <div id="wa-form" class="wa-form hidden">
      <div class="wa-form-title">Laporan Pemasangan via WhatsApp</div>

      <div class="wa-form-row">
        <span class="wa-form-label">Nama</span>
        <div class="wa-form-static" id="wa-nama-static">-</div>
      </div>
      <div class="wa-form-row">
        <span class="wa-form-label">IDPEL</span>
        <div class="wa-form-static" id="wa-idpel-static">-</div>
      </div>
      <div class="wa-form-row">
        <span class="wa-form-label">Alamat</span>
        <div class="wa-form-static" id="wa-alamat-static">-</div>
      </div>

      <div class="wa-form-row">
        <label class="wa-form-label" for="tegangan-input">Tegangan kwh</label>
        <input id="tegangan-input" class="wa-input" type="number" inputmode="decimal" placeholder="Misal: 220">
      </div>

      <div class="wa-form-row">
        <label class="wa-form-label" for="wa-number-input">Nomor WA</label>
        <input id="wa-number-input" class="wa-input" type="tel" inputmode="tel" placeholder="Contoh: 08123456789">
      </div>

      <div class="wa-form-row">
        <label class="wa-form-label" for="lokasi-input">Lokasi</label>
        <input id="lokasi-input" class="wa-input" type="text" readonly>
      </div>

      <div class="wa-form-actions">
        <button type="button" class="wa-btn-close" id="wa-close-btn">Tutup</button>
        <button type="button" class="wa-btn-send" id="wa-send-btn">Kirim ke WhatsApp</button>
      </div>
    </div>
  </div>
</div>

<nav class="bottom-nav" id="bottom-nav">
  <button class="nav-item active" data-target="pemasangan" data-title="Pemasangan">üõ†Ô∏è Pemasangan</button>
  <button class="nav-item" data-target="laporan" data-title="Lihat Laporan">üìÑ Lihat Laporan</button>
</nav>

<script>
// ------------------------------
// 1. Daftar semua file gambar
// ------------------------------
const files = [
  "akt kol sanxing hidayat-1.webp","akt kol sanxing hidayat-2.webp","akt kol sanxing hidayat-3.webp",
  "akt kol sanxing hidayat-4.webp","akt kol sanxing hidayat-5.webp","akt kol sanxing hidayat-6.webp",
  "akt kol sanxing hidayat-7.webp","akt kol sanxing hidayat-8.webp","akt kol sanxing hidayat-9.webp",
  "akt kol sanxing hidayat-10.webp","akt kol sanxing hidayat-11.webp","akt kol sanxing hidayat-12.webp",
  "akt kol sanxing hidayat-13.webp","akt kol sanxing hidayat-14.webp","akt kol sanxing hidayat-15.webp",
  "akt kol sanxing hidayat-16.webp","akt kol sanxing hidayat-17.webp","akt kol sanxing hidayat-18.webp",
  "akt kol sanxing hidayat-19.webp","akt kol sanxing hidayat-20.webp","akt kol sanxing hidayat-21.webp",
  "akt kol sanxing hidayat-22.webp","akt kol sanxing hidayat-23.webp","akt kol sanxing hidayat-24.webp",
  "akt kol sanxing hidayat-25.webp","akt kol sanxing hidayat-26.webp","akt kol sanxing hidayat-27.webp",
  "akt kol sanxing hidayat-28.webp","akt kol sanxing hidayat-29.webp","akt kol sanxing hidayat-30.webp",
  "akt kol sanxing hidayat-31.webp","akt kol sanxing hidayat-32.webp","akt kol sanxing hidayat-33.webp",
  "akt kol sanxing hidayat-34.webp","akt kol sanxing hidayat-35.webp","akt kol sanxing hidayat-36.webp",
  "akt kol sanxing hidayat-37.webp","akt kol sanxing hidayat-38.webp","akt kol sanxing hidayat-39.webp",
  "akt kol sanxing hidayat-40.webp","akt kol sanxing hidayat-41.webp","akt kol sanxing hidayat-42.webp",
  "akt kol sanxing hidayat-43.webp","akt kol sanxing hidayat-44.webp","akt kol sanxing hidayat-45.webp",
  "akt kol sanxing hidayat-46.webp","akt kol sanxing hidayat-47.webp","akt kol sanxing hidayat-48.webp",
  "akt kol sanxing hidayat-49.webp","akt kol sanxing hidayat-50.webp","akt kol sanxing hidayat-51.webp",
  "akt kol sanxing hidayat-52.webp","akt kol sanxing hidayat-53.webp","akt kol sanxing hidayat-54.webp",
  "akt kol sanxing hidayat-55.webp","akt kol sanxing hidayat-56.webp","akt kol sanxing hidayat-57.webp",
  "akt kol sanxing hidayat-58.webp","akt kol sanxing hidayat-59.webp","akt kol sanxing hidayat-60.webp",
  "akt kol sanxing hidayat-61.webp","akt kol sanxing hidayat-62.webp","akt kol sanxing hidayat-63.webp",
  "akt kol sanxing hidayat-64.webp","akt kol sanxing hidayat-65.webp","akt kol sanxing hidayat-66.webp",
  "akt kol sanxing hidayat-67.webp","akt kol sanxing hidayat-68.webp","akt kol sanxing hidayat-69.webp",
  "akt kol sanxing hidayat-70.webp","akt kol sanxing hidayat-71.webp","akt kol sanxing hidayat-72.webp",
  "akt kol sanxing hidayat-73.webp","akt kol sanxing hidayat-74.webp","akt kol sanxing hidayat-75.webp",
  "akt kol sanxing hidayat-76.webp","akt kol sanxing hidayat-77.webp"
];

// ------------------------------
// 2. Mapping filename -> ID Pel
// ------------------------------
const idPelMap = {
  "akt kol sanxing hidayat-10.webp":"522052132974",
  "akt kol sanxing hidayat-11.webp":"522051779331",
  "akt kol sanxing hidayat-1.webp":"522051782525",
  "akt kol sanxing hidayat-14.webp":"522051746502",
  "akt kol sanxing hidayat-13.webp":"522051767702",
  "akt kol sanxing hidayat-12.webp":"522051344755",
  "akt kol sanxing hidayat-15.webp":"522051782708",
  "akt kol sanxing hidayat-17.webp":"522051797405",
  "akt kol sanxing hidayat-16.webp":"522051816290",
  "akt kol sanxing hidayat-19.webp":"522051820358",
  "akt kol sanxing hidayat-2.webp":"522051812538",
  "akt kol sanxing hidayat-18.webp":"522051772368",
  "akt kol sanxing hidayat-22.webp":"522051904524",
  "akt kol sanxing hidayat-20.webp":"522051819447",
  "akt kol sanxing hidayat-21.webp":"522051775842",
  "akt kol sanxing hidayat-23.webp":"522051031913",
  "akt kol sanxing hidayat-25.webp":"522051791597",
  "akt kol sanxing hidayat-24.webp":"522051776637",
  "akt kol sanxing hidayat-26.webp":"522051791762",
  "akt kol sanxing hidayat-27.webp":"522051900685",
  "akt kol sanxing hidayat-28.webp":"522051776716",
  "akt kol sanxing hidayat-30.webp":"522052133105",
  "akt kol sanxing hidayat-3.webp":"522051807507",
  "akt kol sanxing hidayat-29.webp":"522051909326",
  "akt kol sanxing hidayat-33.webp":"522051802945",
  "akt kol sanxing hidayat-32.webp":"522051781714",
  "akt kol sanxing hidayat-31.webp":"522051772462",
  "akt kol sanxing hidayat-35.webp":"522051903085",
  "akt kol sanxing hidayat-36.webp":"522051801424",
  "akt kol sanxing hidayat-34.webp":"522051901895",
  "akt kol sanxing hidayat-37.webp":"522051779858",
  "akt kol sanxing hidayat-39.webp":"522050829034",
  "akt kol sanxing hidayat-38.webp":"522051821527",
  "akt kol sanxing hidayat-41.webp":"522051808404",
  "akt kol sanxing hidayat-4.webp":"522051772080",
  "akt kol sanxing hidayat-40.webp":"522051770857",
  "akt kol sanxing hidayat-42.webp":"522051781158",
  "akt kol sanxing hidayat-44.webp":"522051809700",
  "akt kol sanxing hidayat-43.webp":"522051784538",
  "akt kol sanxing hidayat-47.webp":"522051904382",
  "akt kol sanxing hidayat-46.webp":"522051815145",
  "akt kol sanxing hidayat-45.webp":"522051823658",
  "akt kol sanxing hidayat-5.webp":"522051797583",
  "akt kol sanxing hidayat-49.webp":"522051863422",
  "akt kol sanxing hidayat-48.webp":"522050868977",
  "akt kol sanxing hidayat-50.webp":"522052132336",
  "akt kol sanxing hidayat-52.webp":"522051777743",
  "akt kol sanxing hidayat-51.webp":"522051785094",
  "akt kol sanxing hidayat-55.webp":"522051805544",
  "akt kol sanxing hidayat-54.webp":"522050805388",
  "akt kol sanxing hidayat-53.webp":"522051788338",
  "akt kol sanxing hidayat-58.webp":"522051795475",
  "akt kol sanxing hidayat-57.webp":"522052133432",
  "akt kol sanxing hidayat-56.webp":"522051784347",
  "akt kol sanxing hidayat-6.webp":"522052132369",
  "akt kol sanxing hidayat-60.webp":"522051800462",
  "akt kol sanxing hidayat-59.webp":"522051831327",
  "akt kol sanxing hidayat-62.webp":"522051202159",
  "akt kol sanxing hidayat-63.webp":"522051829844",
  "akt kol sanxing hidayat-61.webp":"522051775012",
  "akt kol sanxing hidayat-65.webp":"522051794529",
  "akt kol sanxing hidayat-66.webp":"522051775598",
  "akt kol sanxing hidayat-64.webp":"522051905774",
  "akt kol sanxing hidayat-68.webp":"522051568799",
  "akt kol sanxing hidayat-67.webp":"522051903426",
  "akt kol sanxing hidayat-69.webp":"522051796095",
  "akt kol sanxing hidayat-70.webp":"522050273221",
  "akt kol sanxing hidayat-71.webp":"522051785833",
  "akt kol sanxing hidayat-7.webp":"522052132422",
  "akt kol sanxing hidayat-74.webp":"522050283298",
  "akt kol sanxing hidayat-72.webp":"522051802994",
  "akt kol sanxing hidayat-73.webp":"522051778425",
  "akt kol sanxing hidayat-77.webp":"522052132820",
  "akt kol sanxing hidayat-75.webp":"522051903570",
  "akt kol sanxing hidayat-76.webp":"522051775722",
  "akt kol sanxing hidayat-8.webp":"522052132759",
  "akt kol sanxing hidayat-9.webp":"522052132414"
};

// ------------------------------
// 3. Ambil & parse CSV sanxing1
// ------------------------------
let dataSanxing = {};
let currentSearchTerm = "";
let currentSelected = null;

// parser CSV sederhana: hormati tanda kutip
function parseCsvLine(line, delim = ",") {
  const result = [];
  let current = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const ch = line[i];

    if (ch === '"') {
      if (inQuotes && line[i + 1] === '"') { // "" -> "
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (ch === delim && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += ch;
    }
  }
  result.push(current);
  return result;
}

fetch("https://raw.githubusercontent.com/zaidhidayat/vkrn_kejajar/main/data/sanxing1")
  .then(r => r.text())
  .then(text => {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    if (!lines.length) {
      renderCards();
      return;
    }

    const headerLine = lines[0].replace(/^\uFEFF/, "");
    const headers = parseCsvLine(headerLine).map(h => h.trim().toUpperCase());

    const idx = name => headers.indexOf(name);

    const iIdPel   = idx("IDPEL");
    const iNama    = idx("NAMA");
    const iNamaPnj = idx("NAMAPNJ");
    const iRt      = idx("RT");
    const iRw      = idx("RW");
    const iKel     = idx("NAMA_KELURAHAN");
    const iKec     = idx("NAMA_KECAMATAN");
    const iKwh     = idx("NOMOR_METER_KWH");
    const iPetugas = idx("PETUGAS");

    for (let i = 1; i < lines.length; i++) {
      const raw = lines[i].trim();
      if (!raw) continue;
      const cols = parseCsvLine(raw);

      const id = iIdPel >= 0 ? (cols[iIdPel] || "").trim() : "";
      if (!id) continue;

      dataSanxing[id] = {
        nama:    iNama    >= 0 ? (cols[iNama]    || "").trim() : "",
        namapnj: iNamaPnj >= 0 ? (cols[iNamaPnj] || "").trim() : "",
        rt:      iRt      >= 0 ? (cols[iRt]      || "").trim() : "",
        rw:      iRw      >= 0 ? (cols[iRw]      || "").trim() : "",
        kel:     iKel     >= 0 ? (cols[iKel]     || "").trim() : "",
        kec:     iKec     >= 0 ? (cols[iKec]     || "").trim() : "",
        kwh:     iKwh     >= 0 ? (cols[iKwh]     || "").trim() : "",
        petugas: iPetugas >= 0 ? (cols[iPetugas] || "").trim() : ""
      };
    }

    renderCards();
  })
  .catch(err => {
    console.error("Gagal mengambil sanxing1:", err);
    renderCards();
  });

// ------------------------------
// 4. Susun alamat dari beberapa kolom
// ------------------------------
function buildAlamat(d) {
  if (!d) return "";
  const parts = [];
  if (d.namapnj) parts.push(d.namapnj);

  const rtRw = [
    d.rt ? `RT ${d.rt}` : "",
    d.rw ? `RW ${d.rw}` : ""
  ].filter(Boolean).join(" / ");
  if (rtRw) parts.push(rtRw);

  if (d.kel) parts.push(d.kel);
  if (d.kec) parts.push(d.kec);

  return parts.join(", ");
}

// ------------------------------
// 5. Render kartu pemasangan
// ------------------------------
function renderCards() {
  const container = document.getElementById("download-list");
  container.innerHTML = "";

  files.forEach(f => {
    const idPel = idPelMap[f] || "";
    const d = idPel ? (dataSanxing[idPel] || {}) : {};
    const alamat = buildAlamat(d);

    const card = document.createElement("a");
    card.className = "download-card";
    card.href = "asset/" + f;
    card.download = "";

    // data untuk pencarian
    card.dataset.search = [
      idPel,
      d.nama || "",
      alamat || "",
      d.kwh || "",
      d.petugas || "",
      f
    ].join(" | ");

    const img = document.createElement("img");
    img.className = "download-thumb";
    img.src = "asset/" + f;
    img.alt = f;

    const info = document.createElement("div");
    info.innerHTML = `
      <div class="info-grid">
        <div class="info-label">Id Pel</div><div class="info-value">${idPel || "-"}</div>
        <div class="info-label">Nama</div><div class="info-value">${d.nama || "-"}</div>
        <div class="info-label">Alamat</div><div class="info-value">${alamat || "-"}</div>
        <div class="info-label">No KWH Sanxing</div><div class="info-value">${d.kwh || "-"}</div>
        <div class="info-label">Petugas</div><div class="info-value">${d.petugas || "-"}</div>
      </div>
    `;

    card.appendChild(img);
    card.appendChild(info);
    container.appendChild(card);

    // klik kartu: hapus layar (sembunyikan daftar) & tampilkan gambar penuh
    card.addEventListener("click", e => {
      e.preventDefault();
      currentSelected = {
        idPel: idPel || "-",
        nama: d.nama || "-",
        alamat: alamat || "-",
        petugas: d.petugas || "-",
        kwh: d.kwh || "-"
      };
      openViewer("asset/" + f);
    });
  });

  // terapkan filter kalau sudah ada teks di kotak pencarian
  applyFilter();
}

// ------------------------------
// 6. Filter kartu berdasarkan pencarian
// ------------------------------
function applyFilter() {
  const term = currentSearchTerm.trim().toLowerCase();
  const cards = document.querySelectorAll(".download-card");

  if (!term) {
    cards.forEach(c => c.style.display = "flex");
    return;
  }

  cards.forEach(c => {
    const haystack = (c.dataset.search || "").toLowerCase();
    if (haystack.includes(term)) {
      c.style.display = "flex";
    } else {
      c.style.display = "none";
    }
  });
}

// event input untuk kotak pencarian
const searchInput = document.getElementById("search-input");
searchInput.addEventListener("input", e => {
  currentSearchTerm = e.target.value;
  applyFilter();
});

// ------------------------------
// 7. Viewer Gambar & WA
// ------------------------------
const mainListContainer = document.getElementById("main-list-container");
const bottomNav = document.getElementById("bottom-nav");
const viewer = document.getElementById("viewer");
const viewerImg = document.getElementById("viewer-img");
const viewerCaption = document.getElementById("viewer-caption");
const viewerBackBtn = document.getElementById("viewer-back-btn");

// --- HISTORY STATE UNTUK TOMBOL BACK PERANGKAT ---
// set state awal sebagai "list" jika belum ada
if (!history.state || !history.state.page) {
  history.replaceState({ page: "list" }, "");
}

// ketika user tekan tombol back (fisik / sistem / browser)
window.addEventListener("popstate", (event) => {
  const state = event.state || {};
  if (state.page === "list") {
    // dari viewer kembali ke list
    if (!viewer.classList.contains("hidden")) {
      closeViewer();
    }
  }
});

function openViewer(src) {
  // push state baru, supaya tombol back kembali ke list
  history.pushState({ page: "viewer" }, "");

  viewerImg.src = src;
  // caption disembunyikan, tapi biarkan kode ini aman
  if (viewerCaption && currentSelected) {
    viewerCaption.textContent = `IDPEL: ${currentSelected.idPel} ‚Ä¢ ${currentSelected.nama} ‚Ä¢ ${currentSelected.alamat}`;
  }

  mainListContainer.classList.add("hidden");
  bottomNav.classList.add("hidden");
  viewer.classList.remove("hidden");
}

function closeViewer() {
  viewer.classList.add("hidden");
  mainListContainer.classList.remove("hidden");
  bottomNav.classList.remove("hidden");
  document.getElementById("wa-form").classList.add("hidden");

  // setelah kembali dari viewer:
  // - bersihkan kotak pencarian
  // - reset filter
  // - kursor siap di kotak pencarian
  currentSearchTerm = "";
  searchInput.value = "";
  applyFilter();
  searchInput.focus();
}

// klik tombol kembali di dalam viewer = sama seperti tombol back sistem
viewerBackBtn.addEventListener("click", () => {
  history.back();
});

// ------------------------------
// 8. Form WhatsApp
// ------------------------------
const waFab = document.getElementById("wa-fab");
const waForm = document.getElementById("wa-form");
const waNamaStatic = document.getElementById("wa-nama-static");
const waIdpelStatic = document.getElementById("wa-idpel-static");
const waAlamatStatic = document.getElementById("wa-alamat-static");
const teganganInput = document.getElementById("tegangan-input");
const waNumberInput = document.getElementById("wa-number-input");
const lokasiInput = document.getElementById("lokasi-input");
const waSendBtn = document.getElementById("wa-send-btn");
const waCloseBtn = document.getElementById("wa-close-btn");

// buka form saat FAB WA diklik
waFab.addEventListener("click", () => {
  if (!currentSelected) {
    alert("Silakan pilih salah satu pemasangan terlebih dahulu.");
    return;
  }

  waNamaStatic.textContent = currentSelected.nama;
  waIdpelStatic.textContent = currentSelected.idPel;
  waAlamatStatic.textContent = currentSelected.alamat;

  teganganInput.value = "";
  waNumberInput.value = "";
  lokasiInput.value = "Mengambil lokasi perangkat...";

  waForm.classList.remove("hidden");

  // minta lokasi perangkat
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const link = `https://maps.google.com/?q=${lat},${lon}`;
        lokasiInput.value = link;
      },
      err => {
        console.error("Gagal mendapatkan lokasi:", err);
        lokasiInput.value = "Lokasi tidak dapat diambil";
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  } else {
    lokasiInput.value = "Perangkat tidak mendukung geolokasi";
  }
});

waCloseBtn.addEventListener("click", () => {
  waForm.classList.add("hidden");
});

// kirim ke WhatsApp
waSendBtn.addEventListener("click", () => {
  if (!currentSelected) {
    alert("Data pemasangan tidak tersedia.");
    return;
  }

  const teg = (teganganInput.value || "").trim();
  const noWa = (waNumberInput.value || "").trim();
  const lokasi = (lokasiInput.value || "").trim();

  const message =
`*LAPORAN PEMASANGAN* 
*VKRN KWH SANXING*

Nama : ${currentSelected.nama}
IDPEL : ${currentSelected.idPel}
Alamat : ${currentSelected.alamat}
Tegangan kwh sanxing : ${teg} V
Nomor WA : ${noWa}
Lokasi Pemasangan : ${lokasi}`;

  const url = "https://wa.me/?text=" + encodeURIComponent(message);
  window.open(url, "_blank");
});

// ------------------------------
// 9. Tab switching
// ------------------------------
document.querySelectorAll(".nav-item").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".nav-item").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    document.getElementById("header-subtitle").textContent = btn.dataset.title;

    document.querySelectorAll(".page").forEach(p => p.classList.remove("active-page"));
    document.getElementById(btn.dataset.target).classList.add("active-page");
  });
});
</script>

</body>
        </html>
