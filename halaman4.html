<style>
  .csv-editor, .csv-editor * {
    box-sizing: border-box;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  .csv-editor {
    font-size: 16px;
    color: #111827;
    width: 100%;
  }

  .csv-editor .app-shell {
    width: 100%;
    max-width: 960px;
    padding: 12px 0;
    margin: 0 auto;
  }

  .csv-editor .card {
    position: relative;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    background: rgba(255, 255, 255, 0.4); /* ~60% transparan */
    border-radius: 24px;
    border: 2px solid #d4af37; /* emas */
    box-shadow: 0 18px 45px rgba(15, 23, 42, 0.25);
    padding: 28px 32px 24px;
    overflow: hidden;
  }

  .csv-editor .card::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg,
      rgba(255, 255, 255, 0.5),
      rgba(255, 255, 255, 0.08));
    opacity: 0.7;
    pointer-events: none;
  }

  .csv-editor .card-inner {
    position: relative;
    z-index: 1;
  }

  .csv-editor h1,
  .csv-editor h2 {
    margin: 0 0 10px;
    letter-spacing: 0.02em;
  }

  .csv-editor h1 {
    font-size: 30px;
    font-weight: 700;
    color: #0b1120;
  }

  .csv-editor h2 {
    font-size: 24px;
    font-weight: 700;
    color: #0b1120;
  }

  .csv-editor .hidden { display: none; }

  .csv-editor label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #111827;
    margin-bottom: 6px;
  }

  .csv-editor .field-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    margin-bottom: 18px;
  }

  .csv-editor .field-row.inline {
    justify-content: flex-start;
  }

  .csv-editor select,
  .csv-editor input[type="password"] {
    border-radius: 999px;
    border: 2px solid #d4af37;
    padding: 10px 16px;
    font-size: 15px;
    outline: none;
    background: rgba(255, 255, 255, 0.8);
    box-shadow:
      inset 0 0 0 1px rgba(255, 255, 255, 0.6),
      0 0 0 1px #d4af37;
    min-width: 240px;
    flex: 1 1 260px;
    transition: box-shadow 0.18s ease, transform 0.12s ease,
                background 0.18s ease, border-color 0.18s ease;
  }

  .csv-editor select:focus,
  .csv-editor input[type="password"]:focus {
    border-color: #d4af37;
    box-shadow:
      0 0 0 2px #d4af37,
      0 12px 28px rgba(34, 197, 94, 0.25);
    background: rgba(255, 255, 255, 0.95);
    transform: translateY(-1px);
  }

  .csv-editor .btn {
    position: relative;
    border-radius: 999px;
    border: 2px solid #d4af37;
    background: radial-gradient(circle at top left,
      rgba(255, 255, 255, 0.95),
      rgba(255, 255, 255, 0.15));
    padding: 9px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    color: #111827;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow:
      0 12px 28px rgba(15, 23, 42, 0.25),
      inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    transition: transform 0.12s ease, box-shadow 0.18s ease,
                background 0.18s ease, filter 0.18s ease;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    text-align: center;
  }

  .csv-editor .btn:hover {
    transform: translateY(-2px);
    box-shadow:
      0 18px 40px rgba(15, 23, 42, 0.32),
      inset 0 0 0 1px rgba(255, 255, 255, 0.85);
    filter: brightness(1.05);
  }

  .csv-editor .btn:active {
    transform: translateY(0);
    box-shadow:
      0 8px 20px rgba(15, 23, 42, 0.22),
      inset 0 0 0 1px rgba(255, 255, 255, 0.7);
    filter: brightness(0.97);
  }

  .csv-editor .btn-primary {
    background: linear-gradient(135deg, #0ea5e9, #22c55e);
    color: #f9fafb;
    border-color: #d4af37;
    box-shadow:
      0 16px 34px rgba(14, 165, 233, 0.55),
      0 0 0 1px #d4af37;
  }

  .csv-editor .btn-primary:hover {
    background: linear-gradient(135deg, #0284c7, #16a34a);
  }

  .csv-editor .btn-danger {
    background: linear-gradient(135deg, #ef4444, #f97316);
    color: #f9fafb;
    border-color: #d4af37;
  }

  .csv-editor .toolbar {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 18px;
  }

  .csv-editor .toolbar-row {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: space-between;
  }

  .csv-editor .toolbar-row .btn { flex: 1; }

  .csv-editor .toolbar-row-middle .btn:nth-child(2) {
    flex: 1.1;
  }

  .csv-editor .table-wrapper {
    width: 100%;
    overflow-x: auto;
    border-radius: 18px;
  }

  .csv-editor table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background: rgba(255, 255, 255, 0.9);
    box-shadow: 0 12px 28px rgba(15, 23, 42, 0.25);
    border: 2px solid #d4af37;
    font-size: 14px;
    min-width: 600px;
  }

  .csv-editor th,
  .csv-editor td {
    padding: 8px 12px;
    border-bottom: 1px solid #d4af37;
  }

  .csv-editor th {
    background: linear-gradient(135deg,
      rgba(14, 165, 233, 0.16),
      rgba(45, 212, 191, 0.14));
    font-weight: 600;
    text-align: left;
    color: #111827;
    border-bottom: 2px solid #d4af37;
  }

  .csv-editor tr:last-child td { border-bottom: none; }

  .csv-editor td[contenteditable="true"] { background: rgba(248, 250, 252, 0.98); }
  .csv-editor td[contenteditable="true"]:hover { background: rgba(219, 234, 254, 0.98); }

  .csv-editor .status {
    font-size: 13px;
    color: #374151;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 999px;
    padding: 8px 14px;
    display: inline-flex;
    margin-top: 12px;
    max-width: 100%;
    white-space: pre-line;
    border: 2px solid #d4af37;
    box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
  }

  .csv-editor .status-accent { border-color: #d4af37; }

  .csv-editor .file-subtitle {
    font-size: 13px;
    color: #4b5563;
    margin-bottom: 12px;
  }

  /* =============== RESPONSIVE =============== */

  @media (max-width: 768px) {
    .csv-editor .app-shell {
      padding: 8px 0;
    }

    .csv-editor .card {
      padding: 18px 14px 16px;
      border-radius: 20px;
      width: 100%;
      max-width: 100%;
    }

    .csv-editor h1 { font-size: 26px; }
    .csv-editor h2 { font-size: 22px; }

    .csv-editor .field-row {
      flex-direction: column;
      align-items: stretch;
    }

    .csv-editor .field-row.inline {
      flex-direction: column;
      align-items: stretch;
    }

    .csv-editor select,
    .csv-editor input[type="password"] {
      width: 100%;
      flex: none;
    }

    .csv-editor .toolbar-row {
      flex-wrap: wrap;
    }

    .csv-editor .btn {
      width: 100%;
      justify-content: center;
    }

    .csv-editor .toolbar-row .btn {
      width: auto;
    }

    .csv-editor table {
      font-size: 13px;
      min-width: 480px;
    }
  }

  @media (max-width: 480px) {
    .csv-editor { font-size: 15px; }
    .csv-editor h1 { font-size: 24px; }
    .csv-editor h2 { font-size: 20px; }

    .csv-editor .card {
      padding: 16px 10px 14px;
    }

    .csv-editor table {
      font-size: 12px;
      min-width: 420px;
    }

    .csv-editor th,
    .csv-editor td {
      padding: 6px 8px;
    }
  }
</style>

<div class="csv-editor">
  <div class="app-shell">
    <div class="card">
      <div class="card-inner">

        <!-- ===============================
             HALAMAN AWAL
        ================================== -->
        <div id="start-screen">
          <h1>CSV Editor</h1>

          <label for="csvSelect">File CSV GitHub</label>
          <div class="field-row">
            <select id="csvSelect">
              <option value="">-- Pilih file CSV --</option>
            </select>
          </div>

          <!-- Tambah & Hapus -->
          <div class="field-row inline">
            <button class="btn" id="btnAddCsv">Ôºã Tambah</button>
            <button class="btn btn-danger" id="btnRemoveCsv">‚úï Hapus</button>
          </div>

          <label for="ghToken">Token GitHub</label>
          <input type="password" id="ghToken" placeholder="Personal Access Token" />

          <div style="margin-top: 18px;">
            <button class="btn btn-primary" id="btnLoad">‚û°Ô∏è Buka & Edit CSV</button>
          </div>

          <div id="startStatus" class="status" style="display:none;"></div>
        </div>

        <!-- ===============================
             HALAMAN EDITOR
        ================================== -->
        <div id="editor-screen" class="hidden">
          <h2 id="editTitle">NamaFile.csv</h2>
          <div id="editSubtitle" class="file-subtitle"></div>

          <div class="toolbar">
            <!-- Baris 1: OK, + Baris, Refresh -->
            <div class="toolbar-row toolbar-row-middle">
              <button class="btn" id="btnEdit">OK</button>
              <button class="btn" id="btnAddRow">Ôºã Baris</button>
              <button class="btn" id="btnRefresh">Refresh</button>
            </div>

            <!-- Baris 2: Simpan & Keluar -->
            <div class="toolbar-row">
              <button class="btn btn-primary" id="btnSave">üíæ Simpan</button>
              <button class="btn btn-danger" id="btnExit">Keluar</button>
            </div>
          </div>

          <div id="tableContainer"></div>

          <div id="editStatus" class="status" style="display:none;"></div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
const csvSelect    = document.getElementById("csvSelect");
const tokenInput   = document.getElementById("ghToken");
const btnLoad      = document.getElementById("btnLoad");
const btnAddCsv    = document.getElementById("btnAddCsv");
const btnRemoveCsv = document.getElementById("btnRemoveCsv");

const btnEdit    = document.getElementById("btnEdit");
const btnAddRow  = document.getElementById("btnAddRow");
const btnRefresh = document.getElementById("btnRefresh");
const btnSave    = document.getElementById("btnSave");
const btnExit    = document.getElementById("btnExit");

const startScreen  = document.getElementById("start-screen");
const editorScreen = document.getElementById("editor-screen");

const startStatus = document.getElementById("startStatus");
const editStatus  = document.getElementById("editStatus");
const tableContainer = document.getElementById("tableContainer");
const editTitle      = document.getElementById("editTitle");
const editSubtitle   = document.getElementById("editSubtitle");

let csvData = [];
let githubInfo = null;
let isEditing = true;
let csvEntries = []; // { name, url }

const KEY_CSV   = "csvEntries";
const KEY_TOKEN = "githubToken";

function showStartStatus(msg, accent = false) {
  startStatus.textContent = msg;
  startStatus.style.display = msg ? "inline-flex" : "none";
  startStatus.classList.toggle("status-accent", accent);
}

function showEditStatus(msg, accent = false) {
  editStatus.textContent = msg;
  editStatus.style.display = msg ? "inline-flex" : "none";
  editStatus.classList.toggle("status-accent", accent);
}

/* CSV list in browser */
function loadCsvEntries() {
  try {
    const raw = localStorage.getItem(KEY_CSV);
    csvEntries = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(csvEntries)) csvEntries = [];
  } catch { csvEntries = []; }
}

function saveCsvEntries() {
  localStorage.setItem(KEY_CSV, JSON.stringify(csvEntries));
}

function renderCsvSelect() {
  csvSelect.innerHTML = "";
  const placeholder = document.createElement("option");
  placeholder.value = "";
  placeholder.textContent = "-- Pilih file CSV --";
  csvSelect.appendChild(placeholder);

  csvEntries.forEach(entry => {
    const opt = document.createElement("option");
    opt.value = entry.url;
    opt.textContent = entry.name;
    csvSelect.appendChild(opt);
  });
}

/* Token in browser */
function loadToken() {
  const saved = localStorage.getItem(KEY_TOKEN);
  if (saved) tokenInput.value = saved;
}
tokenInput.addEventListener("input", () => {
  localStorage.setItem(KEY_TOKEN, tokenInput.value);
});

/* Tambah & hapus pilihan CSV */
btnAddCsv.addEventListener("click", () => {
  const name = prompt("Nama tampilan di menu (misal: 'Alamat', 'Data Urban', dll):");
  if (!name || !name.trim()) return;

  const url = prompt("URL CSV GitHub (boleh format blob atau raw):");
  if (!url || !url.trim()) return;

  const entry = { name: name.trim(), url: url.trim() };
  csvEntries.push(entry);
  saveCsvEntries();
  renderCsvSelect();
  csvSelect.value = entry.url;
  showStartStatus("Pilihan CSV baru ditambahkan.", true);
});

btnRemoveCsv.addEventListener("click", () => {
  const currentUrl = csvSelect.value;
  if (!currentUrl) { alert("Pilih entri yang ingin dihapus."); return; }

  const entry = csvEntries.find(e => e.url === currentUrl);
  const label = entry ? entry.name : currentUrl;
  if (!confirm('Hapus "' + label + '" dari daftar?')) return;

  csvEntries = csvEntries.filter(e => e.url !== currentUrl);
  saveCsvEntries();
  renderCsvSelect();
  showStartStatus("Pilihan CSV dihapus.");
});

/* Parse URL GitHub */
function parseGithubUrl(url) {
  const u = new URL(url);
  const p = u.pathname.split("/").filter(Boolean);

  if (u.hostname === "raw.githubusercontent.com") {
    if (p.length < 4) throw Error("URL raw GitHub tidak lengkap.");
    const [owner, repo, branch, ...rest] = p;
    return {
      owner, repo, branch,
      path: rest.join("/"),
      rawUrl: url,
      apiUrl: `https://api.github.com/repos/${owner}/${repo}/contents/${rest.join("/")}`
    };
  }

  if (u.hostname === "github.com") {
    if (p.length < 4) throw Error("URL GitHub tidak lengkap.");
    const owner = p[0];
    const repo  = p[1];
    const blobIdx = p.indexOf("blob");
    if (blobIdx === -1) throw Error("URL GitHub harus mengandung /blob/branch/path");
    const branch = p[blobIdx + 1];
    const path   = p.slice(blobIdx + 2).join("/");

    return {
      owner, repo, branch, path,
      rawUrl: `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`,
      apiUrl: `https://api.github.com/repos/${owner}/${repo}/contents/${path}`
    };
  }

  throw Error("URL bukan GitHub.");
}

/* CSV helper */
function parseCSV(text) {
  return text.split(/\r?\n/).filter(Boolean).map(r => r.split(","));
}
function toCSV(data) {
  return data.map(r => r.join(",")).join("\n");
}

/* Render table */
function renderTable() {
  if (!csvData.length) {
    tableContainer.innerHTML = "<p>Tidak ada data.</p>";
    return;
  }

  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const tbody = document.createElement("tbody");

  const header = document.createElement("tr");
  csvData[0].forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    header.appendChild(th);
  });
  thead.appendChild(header);

  for (let i = 1; i < csvData.length; i++) {
    const tr = document.createElement("tr");
    csvData[i].forEach(cell => {
      const td = document.createElement("td");
      td.contentEditable = isEditing;
      td.textContent = cell;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }

  table.appendChild(thead);
  table.appendChild(tbody);

  const wrapper = document.createElement("div");
  wrapper.className = "table-wrapper";
  wrapper.appendChild(table);

  tableContainer.innerHTML = "";
  tableContainer.appendChild(wrapper);
}

function readTableBack() {
  const table = tableContainer.querySelector("table");
  if (!table) { csvData = []; return; }
  const rows = [...table.querySelectorAll("tr")];
  csvData = rows.map(r => [...r.children].map(c => c.textContent.trim()));
}

/* Load CSV */
btnLoad.addEventListener("click", async () => {
  const selectedUrl = csvSelect.value;
  showStartStatus("");

  if (!selectedUrl) {
    showStartStatus("Pilih file CSV terlebih dahulu.");
    return;
  }

  try {
    githubInfo = parseGithubUrl(selectedUrl);

    showStartStatus("Mengambil CSV dari GitHub...", true);
    const res = await fetch(githubInfo.rawUrl);
    if (!res.ok) throw Error("Gagal mengambil CSV (status " + res.status + ")");

    csvData = parseCSV(await res.text());

    startScreen.classList.add("hidden");
    editorScreen.classList.remove("hidden");

    isEditing = true;
    btnEdit.textContent = "OK";

    const fileName = githubInfo.path.split("/").pop();
    editTitle.textContent = fileName || githubInfo.path || "File CSV";
    editSubtitle.textContent = githubInfo.repo + "/" + githubInfo.path;

    renderTable();
    showEditStatus("CSV siap diedit.", true);
  } catch (e) {
    showStartStatus("Error: " + e.message);
  }
});

/* Refresh CSV */
btnRefresh.addEventListener("click", async () => {
  if (!githubInfo) { showEditStatus("Belum ada file yang dimuat."); return; }
  if (!confirm("Perubahan lokal yang belum disimpan akan hilang. Lanjutkan refresh?")) return;

  try {
    showEditStatus("Refresh dari GitHub...");
    const res = await fetch(githubInfo.rawUrl);
    if (!res.ok) throw Error("Gagal refresh (status " + res.status + ")");
    csvData = parseCSV(await res.text());
    renderTable();
    showEditStatus("Sudah sinkron dengan GitHub.", true);
  } catch (e) {
    showEditStatus("Error: " + e.message);
  }
});

/* Toggle edit mode */
btnEdit.addEventListener("click", () => {
  if (!csvData.length) return;
  readTableBack();
  isEditing = !isEditing;
  btnEdit.textContent = isEditing ? "OK" : "Edit";
  renderTable();
  showEditStatus(isEditing ? "Mode edit aktif." : "Mode lihat saja.");
});

/* Add row */
btnAddRow.addEventListener("click", () => {
  if (!csvData.length) { showEditStatus("Belum ada data."); return; }
  readTableBack();
  csvData.push(new Array(csvData[0].length).fill(""));
  renderTable();
  showEditStatus("Baris baru ditambahkan.", true);
});

/* Save to GitHub */
btnSave.addEventListener("click", async () => {
  const token = tokenInput.value.trim();
  if (!token) { showEditStatus("Isi token GitHub dulu."); return; }
  localStorage.setItem(KEY_TOKEN, token);

  if (!githubInfo) { showEditStatus("Belum ada file yang dimuat."); return; }

  readTableBack();
  const csvText = toCSV(csvData);
  const base64 = btoa(unescape(encodeURIComponent(csvText)));

  try {
    showEditStatus("Mengambil SHA file...");
    const shaRes = await fetch(githubInfo.apiUrl, {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!shaRes.ok) throw Error("Gagal ambil info file (status " + shaRes.status + ")");
    const shaJson = await shaRes.json();

    showEditStatus("Mengirim update ke GitHub...");
    const putRes = await fetch(githubInfo.apiUrl, {
      method: "PUT",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Update CSV via web",
        content: base64,
        sha: shaJson.sha
      })
    });

    if (!putRes.ok) throw Error("Gagal commit (status " + putRes.status + ")");
    showEditStatus("Berhasil menyimpan ke GitHub. ‚úîÔ∏è", true);
  } catch (e) {
    showEditStatus("Error: " + e.message);
  }
});

/* Keluar */
btnExit.addEventListener("click", () => {
  location.reload();
});

/* INIT */
function initCsvEditor() {
  loadCsvEntries();
  renderCsvSelect();
  loadToken();
}

initCsvEditor();
</script>
